
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>CPU Scheduling Simulator</title>
	<!-- Bootstrap CSS file -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
	<title>Ground Reference Simulator</title>
</head>
<body>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

<script src="simulator/sim.js"></script>
<script src="schedulers/fifo.js"></script>
<script src="gui/gui.js"></script>

<header class="page-header header container-fluid" style="text-align:center">
CPU Scheduler Simulator
</header>

<style>
	/* Tooltip container */
	.tooltip {
	  position: relative;
	  display: inline-block;
	  border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
	}
	
	/* Tooltip text */
	.tooltip .tooltiptext {
	  visibility: hidden;
	  width: 120px;
	  background-color: black;
	  color: #fff;
	  text-align: center;
	  padding: 5px 0;
	  border-radius: 6px;
	 
	  /* Position the tooltip text - see examples below! */
	  position: absolute;
	  z-index: 1;
	}
	
	/* Show the tooltip text when you mouse over the tooltip container */
	.tooltip:hover .tooltiptext {
	  visibility: visible;
	}

	.scheduler {
		border: 2px solid black;
		border-radius: 10px;
		text-align: center;
	}
	.schedulertitle {
		color: white;
		background-color: gray;
	}
	/* .queues {
		border: 2px solid gray;
		border-radius: 10px;
	} */
	.border {
		border: 2px solid gray;
		border-radius: 10px;
	}
</style>


<div class="row" style="text-align:center">
	<div class="col-md-12">

		<input type="button" class="postsim" value="Reset" style="border-radius: 6px;" onclick="resetSimulation();">
	</div>
</div>

<div class="row" style="text-align:center">
	<div class="col-6">
		<input type="range" class="presim" id="max_jobs_slider" min="1" max="100" onchange="document.getElementById('#max_jobs_label').innerHTML = this.value;">Max Jobs:<span id="#max_jobs_label"></span>
	</div>
	<div class="col-6">
		System Type:
		<select id="#system_type_selector" name="system_type" class="presim" onchange="systemChanged();"></select>
	</div>
</div>
<div class="row" style="text-align:center">
	<div class="col">
		<input type="button" class="presim" value="Run" style="border-radius: 6px;" onclick="runSimulation();">
		<div id="#time_slice">Time Slice: </div>
	</div>
</div>

<div class="row" style="text-align:center">
	<div class="col-md-12">
		<input type="button" class="postsim" id="rev_all" value="|<<" style="border-radius: 6px;" onclick="revAll();">
		<input type="button" class="postsim" id="rev_one" value="|<" style="border-radius: 6px;" onclick="adjustTimeSlice(-1);">
		<input type="button" class="postsim" id="fwd_one" value=">|" style="border-radius: 6px;" onclick="adjustTimeSlice(1);">
		<input type="button" class="postsim" id="fwd_all" value=">>|" style="border-radius: 6px;" onclick="fwdAll();">
	</div>
</div>


<div class="container">
	<!-- Scheduler Box -->
	<div class="row scheduler">
		<!-- Scheduler Box -->
		<div class="container">
			<select id="#scheduler_0_selector" name="scheduler_0" class="presim"></select>
			<div class="row border">
				<!-- Queues -->
				<div class="col-10 border" id="#scheduler_0_queues">
					Queues
					<div class="row border">
						<div class="col-1 border">Pri0</div>
						<div class="col-11 border">
							<div class="row" id="#scheduler_0_queue_0">
								<div class="col"></div><!-- consumes extra space to push things right -->
								<div class="col-1" style="border: 2px solid gray; border-radius: 4px">P12</div>
								<div class="col-1" style="border: 2px solid gray; border-radius: 4px;">P23</div>
								<div class="col-1" style="border: 2px solid orange; border-radius: 4px;">P7</div>
								<div class="col-1" style="border: 2px solid green; border-radius: 4px">P15</div>	
								<div class="col-1" style="border: 2px solid blue; border-radius: 4px">P19</div>
								<div class="col-1" style="border: 2px solid red; border-radius: 4px">P22</div>	
							</div>
						</div>
					</div>

					<div class="row border">
						<div class="col-1 border">WAIT</div>
						<div class="col-11 border">
							<div class="row" id="#scheduler_0_queue_1" style="color: lightgray;">
								<div class="col"></div><!-- consumes extra space to push things right -->
								<div class="col-1 border">P51</div>
								<div class="col-1 border">P1</div>
								<div class="col-1 border">P38</div>	
								<div class="col-1 border">P18</div>	
							</div>
						</div>
					</div>
				</div>
				<!-- CPUs -->
				<div class="col-md-2 border" id="#scheduler_0_cpus">
					CPUs
					<div class="row">
						<div class="col border" id="#scheduler_0_cpu_0">
							CPU0<br/>
							<div style="border: 2px solid red; border-radius: 10px; text-align: center;">P22</div>
						</div>
					</div>
					<div class="row">
						<div class="col border" id="#scheduler_0_cpu_1">
							CPU1
							<div style="border: 2px solid blue; border-radius: 10px; text-align: center;">P19</div>
						</div>
					</div>
					<div class="row">
						<div class="col border" id="#scheduler_0_cpu_2">
							CPU2
							<div style="border: 2px solid green; border-radius: 10px; text-align: center;">P15</div>
						</div>
					</div>
					<div class="row">
						<div class="col border" id="#scheduler_0_cpu_3">
							CPU3
							<div style="border: 2px solid orange; border-radius: 10px; text-align: center;">P7</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row" style="border: 2px solid gray; border-radius: 10px">
				<div class="col">
					<div class="row">
						<div class="col">
							Statistics
						</div>
					</div>
					<div class="row">
						<div class="col-6">So Far</div>
						<div class="col-6">Entire Run</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="INSERT_MARKER">
		<div class="row">
			<div class="col">
				<div style="border: 2px solid gray; border-radius: 10px">
					Add another scheduler
				</div>
			</div>
		</div>
	</div>



<script>

let systems = [ 
		new System("1-CPU System", 1),
		new System("2-CPU System", 2),
		new System("4-CPU System", 4),
	]

	// let schedulers = [
	// 	new RandomScheduler("Random Scheduler", systems[0]),
	// 	new FIFOScheduler("FIFO Scheduler", systems[0]),
	// 	new RRScheduler("Round Robin Scheduler", systems[0]),
	//  new MultiFIFOScheduler("Multi FIFO Scheduler", systems[0])
	// ]

	var time_slice = 0
	var schedulers = []
	var traces = [] // Here is where we'll store the traces from the schedulers
	var runtimes = [] // How long each scheduler took to complete everything
	var max_runtime // The longest of the runtimes
	var rng_seed = 55

	resetSimulation();
	populateSystemSelector();
	populateSchedulerSelector(0);
	buildUICpuColumn(0)

	addScheduler(new RandomScheduler("Random Scheduler", getSelectedSystem(), rng_seed))
	addScheduler(new FIFOScheduler("FIFO Scheduler", getSelectedSystem()))
	addScheduler(new RRScheduler("Round Robin Scheduler", getSelectedSystem()))
	addScheduler(new MultiFIFOScheduler("MultiFIFOScheduler Scheduler", getSelectedSystem()))
	//addScheduler(new PriorityScheduler("PriorityScheduler Scheduler", getSelectedSystem()))

	function addScheduler(scheduler) {
		appendSchedulerUI(scheduler)
		schedulers.push(scheduler)
	}

	function systemChanged() {
		buildUICpuColumn(0)
		// Notify schedulers that the system has changed (as some may need to change their queues)
		schedulers.forEach((scheduler) => scheduler.setSystem())
		// Now, rebuild the queues column for each scheduler's UI, in case their queues changed
	}

	////////////////////////////////////////////////////////////////
	// Viewer control (fwd/rev)
	////////////////////////////////////////////////////////////////
	function adjustTimeSlice(offset) {
		console.log("Adjusting time slice by " + offset)
		time_slice += offset
		if (time_slice < 0) { time_slice = 0 }
		if (time_slice > max_runtime) { time_slice = max_runtime }
		console.log("time_slice is now " + time_slice)
		console.log("Scheduler[0]'s trace for this cycle is now : " + JSON.stringify(traces[0].trace_object_list[time_slice]))
		updateUI()
	}

	function updateUI() {
		updateUITimeSlice()
		updateUISchedulerQueues(0)
		updateUISchedulerCpus(0)
	}

	function updateUITimeSlice() {
		document.getElementById("#time_slice").innerHTML = "Time Slice : " + time_slice
	}



	function getProcessBox(text) {
		var new_element = document.createElement("div")
		new_element.className = "border"
		new_element.style = "min-height: 30px;"
		new_element.appendChild(document.createTextNode(text))
		return new_element
	}

	function populateSystemSelector() {
		var selectBox = getAndEmptyElement("#system_type_selector")
		// var selectBox = document.getElementById("#system_type_selector")
		// // Clear existing box
		// while(selectBox.firstChild) {
		// 	selectBox.removeChild(selectBox.firstChild)
		// }
		for(i=0; i<systems.length; i++) {
			var new_option = document.createElement("option")
			new_option.value = i
			new_option.text = systems[i].name
			selectBox.appendChild(new_option)
		}
		selectBox.selectedIndex = 0
	}

	function populateSchedulerSelector(scheduler_num) {
		let id = `#scheduler_${scheduler_num}_selector`
		console.log("ID = " + id)
		var selectBox = document.getElementById(id)
		// Clear existing box
		while(selectBox.firstChild) {
			selectBox.removeChild(selectBox.firstChild)
		}
		for(i=0; i<schedulers.length; i++) {
			var new_option = document.createElement("option")
			new_option.value = i
			new_option.text = schedulers[i].name
			selectBox.appendChild(new_option)
		}
		selectBox.selectedIndex = 0
	}

	////////////////////////////////////////////////////////////////
	// Name generators
	////////////////////////////////////////////////////////////////
	function getSchedulerID(scheduler_num) { return `#scheduler_${scheduler_num}` }
	function getSchedulerCpuID(scheduler_num, cpu_num) { return `#scheduler_${scheduler_num}_cpu_${cpu_num}` }
	function getSchedulerQueueID(scheduler_num, queue_num) { return `#scheduler_${scheduler_num}_queue_${queue_num}` }
	
	////////////////////////////////////////////////////////////////
	// UI Update
	////////////////////////////////////////////////////////////////
	function getAndEmptyElement(element_id) {
		var element = document.getElementById(element_id)
		while(element.firstChild) {
			element.removeChild(element.firstChild)
		}
		return element
	}

	function updateUISchedulerQueue(element_id, processes) {
		console.log("We would update element " + element_id + " with " + processes.length + " processes")
		let element = getAndEmptyElement(element_id)
		var column_pad = document.createElement("div")
		column_pad.className = "col"
		element.appendChild(column_pad)
		// We have to reverse the list because the "front" of the queue is on the right
		console.log("processes = " + JSON.stringify(processes))
		processes.forEach((process) => {
			console.log("  process = " + JSON.stringify(process))
			let process_element = document.createElement("div")
			process_element.className = "col-1 border"
			process_element.innerHTML = "P" + process.job_number
			element.appendChild(process_element)
		})
	}

	function updateUISchedulerQueues(scheduler_num) {
		// Update all of the run queues
		console.log("Updating from scheduler " + scheduler_num)
		console.log("  " + JSON.stringify(schedulers[scheduler_num]))
		for(queue_num=0; queue_num<schedulers[scheduler_num].queue_names.length; queue_num++) {
			console.log("trace queue for scheduler " + scheduler_num + " queues" + " are " + JSON.stringify(traces[scheduler_num].trace_object_list[time_slice].queues))
			updateUISchedulerQueue(
				getSchedulerQueueID(scheduler_num, queue_num),
				traces[scheduler_num].trace_object_list[time_slice].queues[queue_num]
			)
		}
		// Update the waiting list (which is numbered the next integer after the last run queue)
		updateUISchedulerQueue(
				getSchedulerQueueID(scheduler_num, schedulers[scheduler_num].queue_names.length),
				traces[scheduler_num].trace_object_list[time_slice].waiting_jobs
		)
	}

	function updateUISchedulerCpu(element_id, process) {
		let element = getAndEmptyElement(element_id)
		element.appendChild(document.createTextNode("CPU0"))
		console.log("  process = " + JSON.stringify(process))
		let process_element = document.createElement("div")
		process_element.className = "border"
		if (process == null) {
			process_element.innerHTML = "IDLE"
		} else {
			process_element.innerHTML = "P" + process.job_number
		}
		element.appendChild(process_element)
	}

	function updateUISchedulerCpus(scheduler_num) {
		for (cpu_num=0; cpu_num<getSelectedSystem().cpus; cpu_num++) {
			updateUISchedulerCpu(
				getSchedulerCpuID(scheduler_num, cpu_num),
				traces[scheduler_num].trace_object_list[time_slice].assignments[cpu_num]
			)
		}
	}

	function buildUICpuColumn(scheduler_num) {
		let id = `#scheduler_${scheduler_num}_cpus`
		console.log("ID = " + id)
		var cpuBox = document.getElementById(id)
		// Clear existing box
		while(cpuBox.firstChild) {
			cpuBox.removeChild(cpuBox.firstChild)
		}
		cpuBox.appendChild(document.createTextNode("CPUs"))
		let selected_system = getSelectedSystem()
		console.log(JSON.stringify(selected_system))
		for(i=0; i<selected_system.cpus; i++) {
			console.log("Adding CPU"+i)
			var row_element = document.createElement("div")
			row_element.className = "row border"

			var new_element = document.createElement("div")
			new_element.className = "col border"
			new_element.id = `#scheduler_${scheduler_num}_cpu_${i}`
			new_element.appendChild(document.createTextNode("CPU" + i))
			new_element.appendChild(getProcessBox("FIXTHIS"))

			row_element.appendChild(new_element)

			cpuBox.appendChild(row_element)
		}

	}

	function getSelectedSystem() {
		let systemTypeSelector = document.getElementById("#system_type_selector")
		console.log("System Type Selector index = " + systemTypeSelector.selectedIndex)
		return systems[systemTypeSelector.selectedIndex]
	}

	function appendSchedulerUI(scheduler) {
		var insertPoint = document.getElementById("INSERT_MARKER")
		var newElement = document.createElement("div")
		newElement.className = "row"
		newElement.style = "border: 2px solid yellow; border-radius: 10px; text-align: center;"
		newElement.appendChild(document.createTextNode("This is a test"))
		insertPoint.parentNode.insertBefore(newElement, insertPoint)
	}


	////////////////////////////////////////////////////////////////
	// Simulation Reset/Run
	////////////////////////////////////////////////////////////////
	function resetSimulation() {
		// Disable any post-simulation UI elements and enable any pre-simulation ones
		var elements = document.querySelectorAll('.presim')
		elements.forEach((element) => element.disabled = false)
		var elements = document.querySelectorAll('.postsim')
		elements.forEach((element) => element.disabled = true)

	}

	function runSimulation() {
		// Disable any pre-simulation UI elements and enable any post-simulation ones
		var elements = document.querySelectorAll('.presim')
		elements.forEach((element) => element.disabled = true)
		var elements = document.querySelectorAll('.postsim')
		elements.forEach((element) => element.disabled = false)
		// TOOD: Actually call the simulator with parameters from the UI
		console.log("Running simulation")
		traces = simulator(getSelectedSystem(), schedulers, 55)
		max_runtime = 0
		for(i=0; i<traces.length; i++) {
			runtimes[i] = traces[i].trace_object_list.length
			// Find the largest runtime
			max_runtime = runtimes[i] > max_runtime ? runtimes[i] : max_runtime
		}

		console.log("There are " + (traces.length) + " traces")
		for (i=0; i<traces.length; i++) {
			console.log("Scheduler " + i + " needed " + traces[i].trace_object_list.length + " cycles")
		}
		time_slice = 0
		updateUI()

	}



</script>
</body>
</html>

